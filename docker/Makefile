GIT_TAG = "master"
GRAALVM_VERSION = "1.0.0-rc15"

.PHONY: build pull

# Docker container which contains the benchmarking suite
build_BENCHMARK_HARNESS:
	docker build -t "cicro/benchmark-harness" ../

pull_BENCHMARK_HARNESS:
	docker pull "cicro/benchmark-harness"

# Docker container which contains the main dependencies
build_BENCHMARK_BASE:
	$(MAKE) -C BENCHMARK_BASE build

pull_BENCHMARK_BASE:
	$(MAKE) -C BENCHMARK_BASE pull

build_CLANG_BASE:
	$(MAKE) -C BENCHMARK_CLANG_BASE build

# Docker containers for various clang versions
BENCHMARK_TARGETS_CLANG = 3.3 3.4 3.5 3.6 3.7 3.8 4 5 6 7 8
BUILD_BENCHMARK_TARGETS_CLANG = $(addprefix build_BENCHMARK_CLANG-, $(BENCHMARK_TARGETS_CLANG))
PULL_BENCHMARK_TARGETS_CLANG = $(addprefix pull_BENCHMARK_CLANG-, $(BENCHMARK_TARGETS_CLANG))
build_BENCHMARK_CLANG: $(BUILD_BENCHMARK_TARGETS_CLANG)
pull_BENCHMARK_CLANG: $(PULL_BENCHMARK_TARGETS_CLANG)

# Docker containers for various gcc versions
BENCHMARK_TARGETS_GCC = 4.4 4.5 4.6 4.7 4.8 4.9 5 6 7 8
BUILD_BENCHMARK_TARGETS_GCC = $(addprefix build_BENCHMARK_GCC-, $(BENCHMARK_TARGETS_GCC))
PULL_BENCHMARK_TARGETS_GCC = $(addprefix pull_BENCHMARK_GCC-, $(BENCHMARK_TARGETS_GCC))
build_BENCHMARK_GCC: $(BUILD_BENCHMARK_TARGETS_GCC)
pull_BENCHMARK_GCC: $(PULL_BENCHMARK_TARGETS_GCC)

# Docker containers for various other programs
BENCHMARK_TARGETS_OTHER = BOEHMGC COMPCERT DMALLOC DRMEMORY LOWFAT QEMU SULONG TCC VALGRIND DIEHARD JEMALLOC HOARD FREEGUARD LIBDISLOCATOR TCMALLOC DLMALLOC TLSF STRACE RPMALLOC POLLY CLANG-8-LLD CLANG-8-GOLD-LD INTROSPECTION USR-BIN-TIME SCALLOC LOCKFREE-MALLOC
BUILD_BENCHMARK_TARGETS_OTHER = $(addprefix build_BENCHMARK_, $(BENCHMARK_TARGETS_OTHER))
PULL_BENCHMARK_TARGETS_OTHER = $(addprefix pull_BENCHMARK_, $(BENCHMARK_TARGETS_OTHER))
build_BENCHMARK_OTHER: $(BUILD_BENCHMARK_TARGETS_OTHER)
pull_BENCHMARK_OTHER: $(PULL_BENCHMARK_TARGETS_OTHER)

# Helper methods
BUILD_BENCHMARK_TARGETS_ALL = $(BUILD_BENCHMARK_TARGETS_CLANG) $(BUILD_BENCHMARK_TARGETS_GCC) $(BUILD_BENCHMARK_TARGETS_OTHER)
PULL_BENCHMARK_TARGETS_ALL = $(PULL_BENCHMARK_TARGETS_CLANG) $(PULL_BENCHMARK_TARGETS_GCC) $(PULL_BENCHMARK_TARGETS_OTHER)

build_BENCHMARK: $(BUILD_BENCHMARK_TARGETS_ALL)
pull_BENCHMARK: $(PULL_BENCHMARK_TARGETS_ALL)

# generic executors
$(BUILD_BENCHMARK_TARGETS_ALL): build_BENCHMARK_BASE build_BENCHMARK_HARNESS build_CLANG_BASE
	$(MAKE) -C $(subst build_,,$@) build

$(PULL_BENCHMARK_TARGETS_ALL):
	$(MAKE) -C $(subst pull_,,$@) pull

# Docker containers for sulong
build_SULONG:
	$(MAKE) -C SULONG build GRAALVM_VERSION=$(GRAALVM_VERSION)

pull_SULONG:
	$(MAKE) -C SULONG build pull GRAALVM_VERSION=$(GRAALVM_VERSION)

build_BENCHMARK_SULONG: build_BENCHMARK_BASE build_SULONG
	$(MAKE) -C BENCHMARK_SULONG build GRAALVM_VERSION=$(GRAALVM_VERSION)

pull_BENCHMARK_SULONG:
	$(MAKE) -C BENCHMARK_SULONG pull GRAALVM_VERSION=$(GRAALVM_VERSION)

# Docker container for various stuff of our harness
build_MERGE:
	$(MAKE) -C MERGE build GIT_TAG=$(GIT_TAG)

build_PLOT: build_BENCHMARK_BASE
	$(MAKE) -C PLOT build

# Main targets
build: build_BENCHMARK build_MERGE build_PLOT
pull: pull_BENCHMARK
