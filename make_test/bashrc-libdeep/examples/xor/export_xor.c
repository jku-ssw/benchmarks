#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <math.h>

#define AF(adder) (1.0f / (1.0f + exp(-(adder))))

const int no_of_input_fields = 2;
const int no_of_inputs = 64;
const int no_of_hiddens = 5;
const int no_of_outputs = 1;
const int hidden_layers = 1;

int field_length[] = {
  32,32
};

float input_range_min[] = {
  0.2500000000,0.2500000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000
};

float input_range_max[] = {
  0.7500000000,0.7500000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000
};

float output_range_min[] = {
  0.0000000000
};

float output_range_max[] = {
  1.0000000000
};

float hidden_layer_0_weights[] = {
  -0.0039872765,-0.0006494609,-0.0066129141,-0.0039000101,-0.0059269033,-0.0067918627,-0.0068751927,-0.0031997913,-0.0017411878,-0.0076824301,-0.0002073799,-0.0076664048,-0.0046129990,-0.0079529155,-0.0061774394,-0.0034745184,-0.0086888075,0.0045423778,-0.0046599782,-0.0032442489,-0.0073501049,-0.0060467655,-0.0055890670,-0.0074582854,-0.0049083689,-0.0073086116,-0.0071580932,-0.0016454750,0.0025249056,-0.0080712792,-0.0041790549,-0.0082899602,-0.0094195185,-0.0056994511,-0.0079428535,-0.0075963009,0.0010995016,-0.0042055571,-0.0045061056,-0.0063785268,-0.0034482090,-0.0032849703,-0.0074934848,-0.0087327240,-0.0068392986,-0.0069337171,-0.0074459268,-0.0006239417,0.0016821451,0.0059820898,-0.0054188804,-0.0034785413,0.0000506648,-0.0078078499,-0.0085355137,-0.0072202068,-0.0028747458,-0.0074120038,-0.0028083876,-0.0049063866,-0.0082246140,-0.0048182723,0.0004216474,-0.0085589997,-0.0083578937,-0.0067516263,-0.0092298817,-0.0050980099,-0.0028035433,-0.0076047690,-0.0071042343,-0.0065676761,0.0011759821,-0.0081104403,-0.0056397212,-0.0090724621,-0.0075514088,-0.0078784283,0.0030388846,-0.0064303433,-0.0071860333,0.0053298799,-0.0080150301,-0.0072657797,-0.0044402303,-0.0075429222,-0.0078958413,0.0011528815,-0.0039478280,0.0019946385,-0.0006336053,-0.0068689454,-0.0061850264,-0.0026478043,-0.0052077714,-0.0063676215,-0.0114627043,-0.0068060583,-0.0038686832,-0.0057087424,-0.0024212615,-0.0077989055,0.0021819838,0.0012245384,-0.0012101193,-0.0085283136,-0.0038629274,-0.0123666460,-0.0013922405,0.0000679402,-0.0059376382,-0.0033181740,-0.0124587798,-0.0012073405,-0.0093262577,-0.0058644782,-0.0014456606,-0.0028868890,0.0019284155,-0.0067254980,-0.0055204495,-0.0052753310,-0.0028678686,0.0020925950,-0.0089332759,-0.0051132268,-0.0037869245,-0.0088582207,-0.0038833050,-0.0067612086,-0.0071238973,-0.0077604200,-0.0018212451,-0.0080362605,-0.0044862437,-0.0064764256,-0.0039686933,-0.0092275757,-0.0081825908,-0.0084598903,-0.0066208402,-0.0026525671,-0.0073759914,-0.0036252686,-0.0070377043,0.0049991626,-0.0067977975,0.0025790622,-0.0043472815,-0.0069493013,-0.0080540832,-0.0040024342,-0.0000548000,-0.0017185234,-0.0073419525,0.0010184158,0.0061672064,-0.0025395476,-0.0049568540,-0.0063729160,-0.0021086566,-0.0036594404,-0.0108341733,-0.0027684697,0.0039246599,-0.0055066305,-0.0064327209,-0.0075059980,-0.0011578498,-0.0052206479,-0.0013411598,-0.0101646772,-0.0073846877,-0.0081771724,-0.0070542195,-0.0027929470,-0.0070550498,0.0044210833,-0.0064451750,-0.0030293977,-0.0020541793,0.0009166582,-0.0081654266,-0.0069092466,-0.0051887869,0.0017036429,-0.0059583108,-0.0060217916,-0.0021849864,-0.0050277743,-0.0048999540,-0.0088049090,-0.0081748953,-0.0077450275,0.0013111584,-0.0013018504,-0.0044325390,-0.0075484375,-0.0041784272,-0.0065863254,-0.0020004634,-0.0074797901,-0.0033111684,-0.0064371680,-0.0057107322,-0.0073258253,-0.0073693702,-0.0040266654,-0.0081525501,0.0020671496,-0.0044314689,-0.0023817765,-0.0055731595,-0.0039958470,-0.0064020380,-0.0024489313,-0.0065373895,0.0024518669,-0.0075510074,-0.0075291223,0.0009152897,0.0063978345,-0.0060811830,0.0022190451,-0.0055182874,-0.0080136303,-0.0014642150,-0.0055571739,-0.0026646017,-0.0078958208,-0.0058752075,-0.0067650024,0.0061836801,-0.0019926704,-0.0009635244,-0.0040058852,-0.0063363118,-0.0044175619,-0.0052333288,-0.0043915035,-0.0074863369,-0.0054636374,-0.0006970432,-0.0057010325,0.0072553745,-0.0043603582,-0.0012466596,0.0040283259,-0.0004607061,-0.0068173679,0.0003320612,-0.0047670156,-0.0021855421,0.0011736852,-0.0060466090,0.0017350472,0.0017682700,-0.0008397854,-0.0086566731,-0.0084735518,-0.0029629052,0.0016381697,-0.0049468884,-0.0046522208,-0.0065177404,-0.0043415837,-0.0073114010,-0.0024791167,-0.0080191726,-0.0076827109,-0.0070700869,-0.0080450373,-0.0017795765,-0.0027977729,-0.0085527766,0.0001641744,0.0003229789,-0.0081588086,-0.0016851773,-0.0006864317,-0.0054495726,-0.0039423108,-0.0037980797,-0.0075308438,-0.0074556442,-0.0058529610,-0.0077587180,-0.0066075185,-0.0082531096,-0.0052085556,-0.0081373099,-0.0081698457,-0.0056770970,-0.0048104059,0.0002075230,-0.0030347495,-0.0040900172,0.0028382074,-0.0077451831,-0.0035689641,-0.0068719969,-0.0052408073,-0.0050233584,-0.0028217635,-0.0063788597,0.0036441835,-0.0086803511,-0.0075707268,-0.0070666405,-0.0030483229,-0.0073607322,-0.0076266727,-0.0079177525,-0.0075864112,-0.0041120481,0.0047367774,-0.0079286313,-0.0051623676,0.0005423666,-0.0029486364
};

float hidden_layer_0_bias[] = {
  -0.0669700429,-0.2159981728,-0.1526459008,-0.2319954783,-0.1561523229
};

float output_layer_weights[] = {
  0.0570037924,0.1915328354,0.1370685101,0.1055022925,0.0314553976
};

float output_layer_bias[] = {
  -0.0172896311
};

float inputs[64];
float network_inputs[64];
float prev_hiddens[5];
float hiddens[5];
float outputs[1];

/* Encode some text into the input units */
void encode_text(char * text,
                 float * inputs, int no_of_inputs,
                 int offset, int max_field_length_chars)
{
  int pos = offset, i, bit, max_chars = strlen(text);

  if (max_chars > (no_of_inputs-offset)/8) {
    max_chars = ((no_of_inputs-offset)/8);
  }
  if (max_chars > max_field_length_chars) {
    max_chars = max_field_length_chars;
  }

  /* for each character in the string */
  for (i = 0; i < max_chars; i++) {
    /* set the bits for this character */
    for (bit = 0; bit < 8; bit++, pos++) {
      if (text[i] & (1<<bit)) {
        inputs[pos] = 0.75;
      }
      else {
        inputs[pos] = 0.25;
      }
    }
  }
  /* set the remaining inputs within the field to neutral */
  while (i < max_field_length_chars) {
    for (bit = 0; bit < 8; bit++) {
      if (pos >= no_of_inputs) {
        i = max_field_length_chars;
        break;
      }
      inputs[pos++] = 0.5;
    }
    i++;
  }
}

int main(int argc, char* argv[])
{
  int i,j,pos;
  float sum;

  if (argc < 2) return -1;

  /* Obtain input values from command arguments */
  for (i = 1; i < argc; i++) {
    if (i > no_of_inputs) return -2;
    inputs[i-1] = atof(argv[i]);
  }

  pos = 0;
  for (i = 0; i < no_of_input_fields; i++) {
    if (field_length[i] == 0) {
      /* Normalise numeric inputs into a 0.25 - 0.75 range */
      network_inputs[pos] = 0.25 + ((inputs[i] - input_range_min[i])*0.50/(input_range_max[i] - input_range_min[i]));
      if (network_inputs[pos] < 0.25) network_inputs[pos] = 0.25;
      if (network_inputs[pos] > 0.75) network_inputs[pos] = 0.75;
      pos++;
    }
    else {
      /* text value */
      encode_text(argv[i+1], network_inputs, no_of_inputs,
                  pos, field_length[i]/8);
      pos += field_length[i];
    }
  }

  /* Hidden layer 0 */
  for (i = 0; i < no_of_hiddens; i++) {
    sum = hidden_layer_0_bias[i];
    for (j = 0; j < no_of_inputs; j++) {
      sum += hidden_layer_0_weights[i*no_of_inputs+j]*network_inputs[j];
    }
    hiddens[i] = AF(sum);
  }
  for (i = 0; i < no_of_hiddens; i++) {
    prev_hiddens[i] = hiddens[i];
  }

  /* Output layer */
  for (i = 0; i < no_of_outputs; i++) {
    sum = output_layer_bias[i];
    for (j = 0; j < 5; j++) {
      sum += output_layer_weights[i*5+j]*prev_hiddens[j];
    }
    outputs[i] = AF(sum);
  }

  for (i = 0; i < no_of_outputs; i++) {
    /* Convert outputs from 0.25 - 0.75 back to their original range */
    outputs[i] = output_range_min[i] + ((outputs[i]-0.25)*(output_range_max[i] - output_range_min[i])/0.50);
    /* Send the outputs to stdout */
    printf("%.10f",outputs[i]);
    if (i < no_of_outputs-1) {
      printf(" ");
    }
  }

  printf("\n");
  return 0;
}
